# Updating the ZKM Obfuscation Name Map

 

# Introduction

[Zelix KlassMaster](http://www.zelix.com/klassmaster/) (ZKM) is a Java bytecode obfuscation tool and is used by UReason to obfuscate a 'boot' jar file used early in the UReason product launch process on an end-user machine. Obfuscation doesn't feature at all in the day-to-day work of a UReason developer. Rather, it's a process that's carried out as part of the product build process. This is done to protect intellectual property by making the process of reverse-engineering Java bytecode into Java source code difficult or pointless.

ZKM uses a mapping file to translate Java package, class, method and field names back and forth between their original, unobfuscated values and their post-obfuscation, obfuscated values. Without the mapping file it would be impossible to interpret exception stacktraces generated by obfuscated bytecode.

Strictly speaking, we should generate (and commit to version control) the map file each time we build a product.  In practice though, we use obfuscation only for a relatively very small number of classes in our codebase (relying instead mainly on encryption and a custom, decrypting classloader for IP protection) so the map file needs only infrequent updating.  Situations that require the map file to be updated include the addition of classes to the boot jar file or changes to classes that are already included in the boot jar file.

Failing to update the map file will *not* prevent a UReason product from running. The worst-case result is that an exception stacktrace submitted by a user cannot be fully unobfuscated for examinition.

# Modifying the Name Map File

The Ant target that obfuscates the boot jar file is configured to use the map file as an *input* to the obfuscation process.  This means we tell ZKM to use the map file when it's deciding what obfuscated names to use for any given non-obfuscated name during the obfuscation process.  Modifying the map file means that we run ZKM but tell it *not* to read the map file on input but instead generate a *replacement* map file as *output*, containing a new set of mappings.  The process in detail:

1.  locate the target named `obfuscate_boot_jar` in the Ant script `platform/build/ant/common/build-product-base.xml`; this contains the text of a ZKM obfuscation script that Ant 'echoes' to the file `obfuscate.txt` at runtime.
2.  in the `echo` task edit the instructions that control the input and output map file:
     ![](/assets/attachments/4359181/4689134.png?effects=drop-shadow)
3.  [build the product base](Building_UReason_Platform_Products_and_Add-ins_in_a_Development_Sandbox);
4.  roll back the change to the build script;
5.  commit the change to `platform/build/ant/ZKM_ObfuscationNameMap.log`.

 

## Attachments:

![](assets/images/icons/bullet_blue.gif){width="8" height="8"} [edit-obfuscation.png](/assets/attachments/4359181/4689134.png) (image/png)

